<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>models.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>models.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <h1>Models and Managers</h1>
<p>The entities used by the project are represented by Django Model classes that enable the Bankifi database
to be autogenerated and provide a number of functional capabilities to support the class behaviour.</p>
<p>The methods contained in each model class are instance specific. The model managers provide functionality
that can go across instances. </p>
<p><strong>Available managers:</strong></p>
<ol>
<li><strong><em>InvoiceManager</em></strong> - Provides a number of cross model utility and aggregation methods for the Invoice Class</li>
</ol>
<p><strong>Available model classes:</strong></p>
<ol>
<li><strong><em>Base</em></strong> - Base parent model for all the models to provide a set of standard timestamp methods</li>
<li><strong><em>Contact</em></strong> - A representation of a supplier or customer contact</li>
<li><strong><em>Invoice</em></strong> - A representation of an invoice</li>
<li><strong><em>Account</em></strong> - A representation of a bank account</li>
<li><strong><em>Transaction</em></strong> - A representation of a bank transaction</li>
<li><strong><em>Loan</em></strong> - A representation of a loan</li>
</ol>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <h3><span id="imports" href="imports"> Imports </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Import Python modules</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">month_name</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span><span class="p">,</span> <span class="n">randrange</span>
<span class="kn">import</span> <span class="nn">itertools</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Import Django modules</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Sum</span><span class="p">,</span> <span class="n">Avg</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">When</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">ExpressionWrapper</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">IntegerField</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">fields</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">CharField</span><span class="p">,</span> <span class="n">Case</span><span class="p">,</span> <span class="n">Value</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.db.models.functions</span> <span class="kn">import</span> <span class="n">ExtractMonth</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="kn">import</span> <span class="n">MinLengthValidator</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">reverse</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Import Bankifi utility methods</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">aggregate.helpers</span> <span class="kn">import</span> <span class="n">get_rates</span>
<span class="kn">from</span> <span class="nn">.utilities</span> <span class="kn">import</span> <span class="n">due_date</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <h3><span id="globals" href="globals"> Globals </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Hard coded Xero account links used for the Loan</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">BFS_CODE</span><span class="o">=</span><span class="s1">&#39;AFFF8D031CF542BAA6E0A781B0F45658&#39;</span>
<span class="n">BFS_NAME</span><span class="o">=</span><span class="s1">&#39;BFS LOAN 3&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <h3><span id="model-managers" href="model-managers"> Model Managers </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p><strong>InvoiceManager(models.Manager)</strong></p>
<p>Provides a number of cross model utility and aggregation methods for the Invoice Class.</p>
<p><strong>Methods:</strong></p>
<ol>
<li><strong><em>aggregate</em></strong> - Returns the total receivables minus the total payables for all unpaid invoice.</li>
<li><strong><em>receivables</em></strong> - Returns the sum of all unpaid receivable invoices.</li>
<li><strong><em>payables</em></strong> - Returns the sum of all unpaid receivable invoices.</li>
<li><strong><em>rec_monthly</em></strong> - Returns a dictionary of total unpaid receivables by month.</li>
<li><strong><em>pay_monthly</em></strong> - Returns a dictionary of total unpaid payables by month.</li>
<li><strong><em>last_due</em></strong> - Return the last due invoice or None.</li>
<li><strong><em>days_to_pay</em></strong> - Return the number of days before the last invoice is due or 0</li>
</ol>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">InvoiceManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p><strong>aggregate(self)</strong></p>
<p>Returns the total receivables minus the total payables for all unpaid invoices.</p>
<p><strong>Returns:</strong></p>
<p>The total receivables minus the total payables for all unpaid invoices.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Using the database to do all the work using aggregation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">aggregate</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="n">balance</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span>
                            <span class="n">Case</span><span class="p">(</span>
                                <span class="n">When</span><span class="p">(</span>
                                    <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">UNPAID</span><span class="p">,</span> 
                                    <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">RECEIVABLE</span><span class="p">,</span>
                                    <span class="n">then</span><span class="o">=</span><span class="s1">&#39;amount&#39;</span>
                                <span class="p">),</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">output_field</span><span class="o">=</span><span class="n">FloatField</span><span class="p">(),</span>
                            <span class="p">)</span>
                        <span class="p">)</span><span class="o">-</span>
                        <span class="n">Sum</span><span class="p">(</span>
                            <span class="n">Case</span><span class="p">(</span>
                                <span class="n">When</span><span class="p">(</span>
                                    <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">UNPAID</span><span class="p">,</span> 
                                    <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">PAYABLE</span><span class="p">,</span>
                                    <span class="n">then</span><span class="o">=</span><span class="s1">&#39;amount&#39;</span>
                                <span class="p">),</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">output_field</span><span class="o">=</span><span class="n">FloatField</span><span class="p">(),</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">aggregate</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">aggregate</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">0.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p><strong>receivables(self)</strong></p>
<p>Returns the sum of all unpaid receivable invoices.</p>
<p><strong>Returns:</strong></p>
<p>The sum of all unpaid receivable invoices or 0 if no invoices.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">receivables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Using the database to do all the work using aggregation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">aggregate</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="n">balance</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span>
                            <span class="n">Case</span><span class="p">(</span>
                                <span class="n">When</span><span class="p">(</span>
                                    <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">UNPAID</span><span class="p">,</span> 
                                    <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">RECEIVABLE</span><span class="p">,</span>
                                    <span class="n">then</span><span class="o">=</span><span class="s1">&#39;amount&#39;</span>
                                <span class="p">),</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">output_field</span><span class="o">=</span><span class="n">FloatField</span><span class="p">(),</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">aggregate</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">aggregate</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">0.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p><strong>payables(self)</strong></p>
<p>Returns the sum of all unpaid payables invoices or 0 if no invoices.</p>
<p><strong>Returns:</strong></p>
<p>The sum of all unpaid payables invoices or 0 if no invoices.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">payables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Using the database to do all the work using aggregation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">aggregate</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="n">balance</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span>
                            <span class="n">Case</span><span class="p">(</span>
                                <span class="n">When</span><span class="p">(</span>
                                    <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">UNPAID</span><span class="p">,</span> 
                                    <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">PAYABLE</span><span class="p">,</span>
                                    <span class="n">then</span><span class="o">=</span><span class="s1">&#39;amount&#39;</span>
                                <span class="p">),</span>
                                <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">output_field</span><span class="o">=</span><span class="n">FloatField</span><span class="p">(),</span>
                            <span class="p">)</span>
                        <span class="p">),</span>
                    <span class="p">)</span>

        <span class="k">return</span> <span class="n">aggregate</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">aggregate</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="mf">0.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p><strong>rec_monthly(self)</strong></p>
<p>Returns a dictionary of total unpaid receivables by month.</p>
<p><strong>Returns:</strong></p>
<p>Dictionary with an ordered list of 'months' and an associated list of monthly invoice 'totals'.
The dictionary lists will be empty if no invoices.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">rec_monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">months</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">invoices</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">UNPAID</span><span class="p">,</span> <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">RECEIVABLE</span><span class="p">)</span><span class="o">.</span>\
                            <span class="n">annotate</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">ExtractMonth</span><span class="p">(</span><span class="s1">&#39;due&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span>\
                            <span class="n">annotate</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">invoices</span><span class="p">:</span>   
            <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_name</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]])</span>
            <span class="n">totals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>

        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;months&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months</span>
        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;totals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totals</span>

        <span class="k">return</span> <span class="n">reply</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p><strong>pay_monthly(self)</strong></p>
<p>Returns a dictionary of total unpaid payables by month.</p>
<p><strong>Returns:</strong></p>
<p>Dictionary with an ordered list of 'months' and an associated list of monthly invoice 'totals'.
The dictionary lists will be empty if no invoices.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pay_monthly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">months</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">invoices</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">UNPAID</span><span class="p">,</span> <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">PAYABLE</span><span class="p">)</span><span class="o">.</span>\
                            <span class="n">annotate</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">ExtractMonth</span><span class="p">(</span><span class="s1">&#39;due&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span>\
                            <span class="n">annotate</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">invoices</span><span class="p">:</span>   
            <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_name</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]])</span>
            <span class="n">totals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>

        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;months&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">months</span>
        <span class="n">reply</span><span class="p">[</span><span class="s1">&#39;totals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">totals</span>

        <span class="k">return</span> <span class="n">reply</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p><strong>last_due(self)</strong></p>
<p>Return the last due invoice.</p>
<p><strong>Returns:</strong></p>
<p>The last due invoice or None.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">last_due</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">UNPAID</span><span class="p">,</span> <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">RECEIVABLE</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-due&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p><strong>days_to_pay(self)</strong></p>
<p>Return the number of days before the last invoice is due.</p>
<p><strong>Returns:</strong></p>
<p>The number of days before the last invoice is due or 0.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">days_to_pay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_due</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">due</span> <span class="o">-</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">last</span> <span class="ow">and</span> <span class="n">last</span><span class="o">.</span><span class="n">due</span> <span class="o">&gt;</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <h3><span id="model-classes" href="model-classes"> Model Classes </span></h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p><strong>Base(models.Model)</strong></p>
<p>Base parent model for all the models to provide a set of standard timestamp methods.</p>
<p><strong>Public Attributes:</strong></p>
<p><strong><em>timestamp</em></strong>: Editable timestamp.</p>
<p><strong><em>created</em></strong>: Date and time model instance was created.</p>
<p><strong><em>updated</em></strong>: Date and time model instance was updated.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Created&quot;</span><span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Last Updated&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Override save method.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">update_timestamp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;update_timestamp&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_timestamp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p><strong>Contact(Base)</strong></p>
<p>A representation of a supplier or customer contact.</p>
<p><strong>Public Attributes:</strong></p>
<p><strong><em>name</em></strong>: Contacts full name.</p>
<p><strong><em>first_name</em></strong>: Contacts first name.</p>
<p><strong><em>last_name</em></strong>: Contacts last name.</p>
<p><strong><em>contact_id</em></strong>: Stores the Xero contact_id.</p>
<p><strong>Methods:</strong></p>
<p><strong><em>is_supplier</em></strong>: Determines if a contact is a supplier.</p>
<p><strong><em>is_customer</em></strong>: Determines if a contact is a customer</p>
<p><strong><em>customer_settle</em></strong>: Calculates the average duration a customer takes to settle invoices.</p>
<p><strong><em>supplier_settle</em></strong>: Calculates the average duration it takes to settle supplier invoices.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Contact</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Name&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;First Name&quot;</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Last Name&quot;</span><span class="p">)</span>
    <span class="n">contact_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Xero Contact ID&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">class</span> <span class="nc">meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Override save method to set the full name using first and last name.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Contact</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p><strong>is_supplier(self)</strong></p>
<p>Determines if a contact is a supplier by checking if they have payable invoices registered against them.</p>
<p><strong>Returns:</strong></p>
<p>True if contact is a supplier otherwise False.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_supplier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contact</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">PAYABLE</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p><strong>is_customer(self)</strong></p>
<p>Determines if a contact is a customer by checking if they have receivable invoices registered against them.</p>
<p><strong>Returns:</strong></p>
<p>True if contact is a supplier otherwise False.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contact</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">RECEIVABLE</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p><strong>customer_settle(self)</strong></p>
<p>Calculates the average duration a customer takes to settle receivable invoices.</p>
<p><strong>Returns:</strong></p>
<p>Average number of days to settle or 0.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">customer_settle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_customer</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">ExpressionWrapper</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;actual&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;raised&#39;</span><span class="p">),</span> <span class="n">output_field</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">DurationField</span><span class="p">())</span>
            <span class="n">settle</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contact__id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                    <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">RECEIVABLE</span><span class="p">,</span> 
                    <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">PAID</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">aggregate</span><span class="p">(</span><span class="n">settle</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;settle&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">settle</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">settle</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p><strong>supplier_settle(self)</strong></p>
<p>Calculates the average duration taken to settle a supplier payable invoice.</p>
<p><strong>Returns:</strong></p>
<p>Average number of days to settle or 0.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">supplier_settle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_supplier</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">ExpressionWrapper</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;actual&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;raised&#39;</span><span class="p">),</span> <span class="n">output_field</span><span class="o">=</span><span class="n">fields</span><span class="o">.</span><span class="n">DurationField</span><span class="p">())</span>
            <span class="n">settle</span> <span class="o">=</span> <span class="n">Invoice</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">contact__id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                    <span class="n">invoice_type</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">PAYABLE</span><span class="p">,</span> 
                    <span class="n">status</span><span class="o">=</span><span class="n">Invoice</span><span class="o">.</span><span class="n">PAID</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span><span class="o">.</span>\
                    <span class="n">aggregate</span><span class="p">(</span><span class="n">settle</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s1">&#39;duration&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;settle&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">settle</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">settle</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;cashflow:contactdetail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p><strong>Invoice(Base)</strong></p>
<p>A representation of an Invoice.</p>
<p>An invoice can be a receivable or a payable. It can be in a paid or unpaid state.
A receivable is an invoiced amount owed by a customer.
A payable is an invoiced amount owed to a supplier.</p>
<p><strong>Public Attributes:</strong></p>
<p><strong><em>invoice_type</em></strong>: type of invoice; PAYABLE or RECEIVABLE.</p>
<p><strong><em>number</em></strong>: invoice number for the Invoice (this should be unique if being used with Xero).</p>
<p><strong><em>contact</em></strong>: foreign key to the contact (customer or supplier) associated with the invoice.</p>
<p><strong><em>raised</em></strong>: date the invoice was raised(i.e created).</p>
<p><strong><em>bank_account</em></strong>: A foreign key to the bank account were the invoice will be paid to/paid from.</p>
<p><strong><em>due</em></strong>: date the invoice is due for payment.</p>
<p><strong><em>expected</em></strong>: date the invoice is expected to be paid based on historic averages.</p>
<p><strong><em>planned</em></strong>: date the invoice is planned to be paid.</p>
<p><strong><em>actual</em></strong>: date the invoice was paid on.</p>
<p><strong><em>amount</em></strong>: invoice amount.</p>
<p><strong><em>status</em></strong>: status of the invoice; PAID or UNPAID.</p>
<p><strong><em>invoice_obj</em></strong>: InvoiceManager.</p>
<p><strong>Methods:</strong></p>
<p><strong><em>pay</em></strong>: Pay an invoice.
<strong><em>days_to_settle</em></strong>: Number of days it took to settle the invoice.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Invoice</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">PAYABLE</span> <span class="o">=</span> <span class="s1">&#39;PAYABLE&#39;</span>
    <span class="n">RECEIVABLE</span> <span class="o">=</span> <span class="s1">&#39;RECEIVABLE&#39;</span>
    <span class="n">INVOICE_TYPE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PAYABLE</span><span class="p">,</span> <span class="s1">&#39;Payable&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">RECEIVABLE</span><span class="p">,</span> <span class="s1">&#39;Receivable&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">PAID</span> <span class="o">=</span> <span class="s1">&#39;PAID&#39;</span>
    <span class="n">UNPAID</span> <span class="o">=</span> <span class="s1">&#39;UNPAID&#39;</span>
    <span class="n">INVOICE_STATUS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PAID</span><span class="p">,</span> <span class="s1">&#39;Paid&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">UNPAID</span><span class="p">,</span> <span class="s1">&#39;Unpaid&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Customer&quot;</span><span class="p">)</span>
    <span class="n">invoice_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">INVOICE_TYPE</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Invoice type&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span>
    <span class="n">number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Invoice number will be autogenerated.&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Invoice Number&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Contact&#39;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Customer/Supplier contact&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Contact&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">raised</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date invoice was raised&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Date Raised&quot;</span><span class="p">,</span> 
        <span class="n">default</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">)</span>
    <span class="n">bank_account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Account&#39;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Bank Account to use for Payable Receivables&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Bank Account&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">due</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date invoice is due&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Date Due&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">due_date</span><span class="p">)</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date invoice is expected to be paid&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Date Expected&quot;</span><span class="p">,</span> 
        <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">planned</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date invoice is planned to be paid&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Date Planned&quot;</span><span class="p">,</span> 
        <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Date invoice was paid&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Date Paid&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
        <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Invoice total amount&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Amount&quot;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">INVOICE_STATUS</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Invoice payment status&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Status&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">UNPAID</span><span class="p">)</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">()</span>
    <span class="n">invoice_obj</span> <span class="o">=</span> <span class="n">InvoiceManager</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">class</span> <span class="nc">meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Override save method to set the planned and expected dates based on historic averages.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Need to save here to get the id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">Invoice</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>Save to set primary key id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="s2">&quot;BI-INV-{0}-{1}-{2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">randrange</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">10000</span><span class="p">),</span> <span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
            

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raised</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNPAID</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoice_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAYABLE</span><span class="p">:</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">supplier_settle</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raised</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">supplier_settle</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">planned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raised</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">supplier_settle</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">due</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">planned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">due</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">planned</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raised</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNPAID</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoice_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECEIVABLE</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoice_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECEIVABLE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">customer_settle</span> <span class="ow">and</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raised</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">customer_settle</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raised</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">customer_settle</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">due</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Invoice</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;cashflow:invoicedetail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p><strong>pay(self, account, xero=None)</strong></p>
<p>Pays an invoice and update Bankifi and Xero.</p>
<p>Future Work: decouple Xero calls from class to allow multiple 3rd party providers</p>
<p><strong>Parameters:</strong></p>
<p><strong><em>account</em></strong>: the account the funds are being deposited to/withdrawn from.</p>
<p><strong><em>xero</em></strong>: xero connection handler.</p>
<p><strong>Returns</strong>:</p>
<p>Nothing</p>
<p><strong>Exceptions:</strong></p>
<p><strong><em>ValidationError</em></strong>: refused</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">account</span><span class="p">,</span> <span class="n">xero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>Retrieve Bankifi account object</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">account_id</span><span class="o">=</span><span class="n">account</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Pay supplier invoice</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">account</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoice_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAYABLE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAID</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">account</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="s2">&quot;Payment to {0} for invoice {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">),</span> 
                    <span class="n">xero</span><span class="p">):</span>
                <span class="n">xero</span><span class="o">.</span><span class="n">payments</span><span class="o">.</span><span class="n">put</span><span class="p">({</span>
                    <span class="s1">&#39;Invoice&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;InvoiceNumber&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">},</span> 
                    <span class="s1">&#39;Account&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="n">account</span><span class="o">.</span><span class="n">account_id</span><span class="p">},</span>
                    <span class="s1">&#39;Amount&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
                    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                    <span class="p">})</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> <span class="s2">&quot;Payment from {0} for invoice {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Mark as paid</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAID</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>     
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;The bank has refused the transaction due to lack of funds available.&quot;</span><span class="p">),</span> 
                    <span class="n">code</span><span class="o">=</span><span class="s1">&#39;refused&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Receive customer invoice payment</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="n">account</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">invoice_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECEIVABLE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAID</span><span class="p">:</span>
            <span class="n">xero</span><span class="o">.</span><span class="n">payments</span><span class="o">.</span><span class="n">put</span><span class="p">({</span>
                <span class="s1">&#39;Invoice&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;InvoiceNumber&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">},</span> 
                <span class="s1">&#39;Account&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="n">account</span><span class="o">.</span><span class="n">account_id</span><span class="p">},</span>
                <span class="s1">&#39;Amount&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span>
                <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="p">})</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">bank_account</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span><span class="p">,</span> 
                <span class="s2">&quot;Payment from {0} for invoice {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contact</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">number</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p><strong>days_to_settle(self)</strong></p>
<p>Returns the number of days it has taken to settle the invoice.</p>
<p><strong><em>Returns:</em></strong></p>
<p>Number of days it has taken to settle the invoice or 0.        </p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">days_to_settle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">raised</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">raised</span> <span class="k">else</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p><strong>Account(Base)</strong></p>
<p>A representation of a Bank Account.</p>
<p>Utilises a subset of banks.
A bank account can have an optional sweep bank account associated with it.
The sweep account will be used to try and return the account to a minimum balance level if 
there is an attempt to withdraw funds that would otherwise cause a transaction to be declined or
cause the account to become overdrawn.</p>
<p>Future Work: decouple Xero calls from class to allow multiple 3rd party providers</p>
<p><strong>Public Attributes:</strong></p>
<p><strong><em>bank</em></strong>: bank name limited by a set of choices.</p>
<p><strong><em>name</em></strong>: account name.</p>
<p><strong><em>sortcode</em></strong>: bank sortcode.</p>
<p><strong><em>account_number</em></strong>: bank account number.</p>
<p><strong><em>sweep_min_balance</em></strong>: minimum balance before sweep rule takes effect.</p>
<p><strong><em>sweep_account</em></strong>: foreign key to optional sweep account.</p>
<p><strong><em>account_id</em></strong>: Id of Xero equivalent account.</p>
<p><strong>Methods:</strong></p>
<p><strong><em>sweep</em></strong>: sweep funds from linked sweep account to restore balance to minimum level.</p>
<p><strong><em>deposit</em></strong>: deposit funds.</p>
<p><strong><em>withdraw</em></strong>: withdraw funds.</p>
<p><strong><em>transaction_check</em></strong>: check if sufficient funds available prior to withdrawal.</p>
<p><strong><em>balance</em></strong>: return the current bank account balance.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Account</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>Subset of available banks. Add to this list to add more or setup in database in future.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">BARCLAYS</span> <span class="o">=</span> <span class="s1">&#39;BARCLAYS&#39;</span>
    <span class="n">HSBC</span> <span class="o">=</span> <span class="s1">&#39;HSBC&#39;</span>
    <span class="n">NORDEA</span> <span class="o">=</span> <span class="s1">&#39;NORDEA&#39;</span>
    <span class="n">NATIONWIDE</span> <span class="o">=</span> <span class="s1">&#39;NATIONWIDE&#39;</span>
    <span class="n">RBS</span> <span class="o">=</span> <span class="s1">&#39;RBS&#39;</span>
    <span class="n">LLOYDS</span> <span class="o">=</span> <span class="s1">&#39;LLOYDS&#39;</span>
    <span class="n">SANTANDER</span> <span class="o">=</span> <span class="s1">&#39;SANTANDER&#39;</span>

    <span class="n">BANK</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">BARCLAYS</span><span class="p">,</span> <span class="s1">&#39;BARCLAYS&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">HSBC</span><span class="p">,</span> <span class="s1">&#39;HSBC&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">NORDEA</span><span class="p">,</span> <span class="s1">&#39;NORDEA&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">NATIONWIDE</span><span class="p">,</span> <span class="s1">&#39;NATIONWIDE&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">RBS</span><span class="p">,</span> <span class="s1">&#39;RBS&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">LLOYDS</span><span class="p">,</span> <span class="s1">&#39;LLOYDS&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SANTANDER</span><span class="p">,</span> <span class="s1">&#39;SANTANDER&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">EURO</span> <span class="o">=</span> <span class="s1">&#39;EURO&#39;</span>
    <span class="n">USD</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span>
    <span class="n">GBP</span> <span class="o">=</span> <span class="s1">&#39;GBP&#39;</span>

    <span class="n">CURRENCY</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">EURO</span><span class="p">,</span> <span class="s1">&#39;EURO&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">USD</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">GBP</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Customer&quot;</span><span class="p">)</span>
    <span class="n">bank</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">BANK</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Bank&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">NATIONWIDE</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Account Name&quot;</span><span class="p">)</span>
    <span class="n">sortcode</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinLengthValidator</span><span class="p">(</span><span class="mi">6</span><span class="p">)],</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Sort Code/Swift BIC&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">account_number</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinLengthValidator</span><span class="p">(</span><span class="mi">8</span><span class="p">)],</span>  
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Account Number/IBAN&quot;</span><span class="p">)</span>
    <span class="n">currency</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">CURRENCY</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Currency&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Currency&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">GBP</span><span class="p">)</span>
    <span class="n">sweep_min_balance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Sweep Balance Limit&quot;</span><span class="p">)</span>
    <span class="n">sweep_account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Account&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
         <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Sweep Account&quot;</span><span class="p">)</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Xero Account ID&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">class</span> <span class="nc">meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bank&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>Override save method to setup made up bank sortcodes and conduct account sweep if necessary.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">sort_codes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;BARCLAYS&#39;</span><span class="p">:</span> <span class="s1">&#39;111111&#39;</span><span class="p">,</span>
            <span class="s1">&#39;HSBC&#39;</span><span class="p">:</span> <span class="s1">&#39;222222&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NORDEA&#39;</span><span class="p">:</span> <span class="s1">&#39;333333&#39;</span><span class="p">,</span>
            <span class="s1">&#39;NATIONWIDE&#39;</span><span class="p">:</span> <span class="s1">&#39;444444&#39;</span><span class="p">,</span>
            <span class="s1">&#39;RBS&#39;</span><span class="p">:</span> <span class="s1">&#39;555555&#39;</span><span class="p">,</span>
            <span class="s1">&#39;LLOYDS&#39;</span><span class="p">:</span> <span class="s1">&#39;666666&#39;</span><span class="p">,</span>
            <span class="s1">&#39;SANTANDER&#39;</span><span class="p">:</span> <span class="s1">&#39;777777&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Bank Account {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>Save to set primary key id</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="nb">super</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sortcode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sortcode</span> <span class="o">=</span> <span class="n">sort_codes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bank</span><span class="p">,</span> <span class="s1">&#39;000000&#39;</span><span class="p">)</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">Account</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">customer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_min_balance</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p><strong>sweep(self, amount=0.0, xero=None)</strong></p>
<p>Sweep funds from linked bank account to restore balance to minimum level.</p>
<p>Sweeps only the funds required to make withdrawal amount and set account to minimum balance.
The sweep is applied to both Bankifi and Xero.</p>
<p>Future Work: decouple Xero calls from class to allow multiple 3rd party providers</p>
<p><strong>Parameters:</strong></p>
<p><strong><em>amount</em></strong>: amount to be withdrawn from account.</p>
<p><strong><em>xero</em></strong>: xero connection object.</p>
<p><strong>Returns:</strong></p>
<p>Nothing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">sweep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">xero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">amount_required</span> <span class="o">=</span> <span class="p">(</span><span class="n">amount</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_min_balance</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_account</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xero</span><span class="p">:</span>
                <span class="n">xero</span><span class="o">.</span><span class="n">banktransfers</span><span class="o">.</span><span class="n">put</span><span class="p">({</span>
                        <span class="s1">&#39;ToBankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span><span class="p">},</span> 
                        <span class="s1">&#39;FromBankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_account</span><span class="o">.</span><span class="n">account_id</span><span class="p">},</span> 
                        <span class="s1">&#39;Amount&#39;</span><span class="p">:</span> <span class="n">amount_required</span><span class="p">,</span>
                        <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep_account</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">amount_required</span><span class="p">,</span> <span class="s2">&quot;Sweep Payment to {0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_number</span><span class="p">),</span> 
                <span class="n">xero</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">amount_required</span><span class="p">,</span> <span class="s2">&quot;Sweep Payment from {0} {1}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sortcode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_number</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p><strong>deposit(self, amount=0.0, description="Deposit", xero=None, contact_id=None, account_id='')</strong></p>
<p>Deposit funds into bank account. Updates Bankifi and Xero account.</p>
<p>Future Work: decouple Xero calls from class to allow multiple 3rd party providers.</p>
<p><strong>Parameters:</strong></p>
<p><strong><em>amount</em></strong>: deposit amount.</p>
<p><strong><em>description</em></strong>: deposit description.</p>
<p><strong><em>xero</em></strong>: xero connection object.</p>
<p><strong><em>contact_id</em></strong>: Xero contact id.</p>
<p><strong><em>account_id</em></strong>: Xero account id.</p>
<p><strong>Returns:</strong></p>
<p>True if successful. False if unsuccessful.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">deposit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Deposit&quot;</span><span class="p">,</span> <span class="n">xero</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contact_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">account_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>Only deposit positive amounts &gt; 0</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xero</span> <span class="ow">and</span> <span class="n">contact_id</span><span class="p">:</span>
                <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;RECEIVE&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Contact&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ContactID&#39;</span><span class="p">:</span> <span class="n">contact_id</span><span class="p">},</span>
                    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                    <span class="s1">&#39;LineAmountTypes&#39;</span><span class="p">:</span> <span class="s1">&#39;Inclusive&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;LineItems&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span> 
                        <span class="s1">&#39;Quantity&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="s1">&#39;UnitAmount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span> <span class="s1">&#39;ItemCode&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">}],</span>
                    <span class="s1">&#39;BankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="n">account_id</span><span class="p">},</span>
                    <span class="s1">&#39;Status&#39;</span><span class="p">:</span> <span class="s1">&#39;AUTHORISED&#39;</span>
                <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>Create Xero transaction to deposit funds</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">xero</span><span class="o">.</span><span class="n">banktransactions</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>Create bankif transaction to deposit funds</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">t</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="n">Transaction</span><span class="o">.</span><span class="n">CREDIT</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span> 
                    <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>Save Bankifi Transaction</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p><strong>withdraw(self, amount=0.0, description="Withdrawal", xero=None, contact_id=None, account_id='')</strong></p>
<p>Withdraw funds from bank account. Updates Bankifi and Xero account.</p>
<p>Future Work: decouple Xero calls from class to allow multiple 3rd party providers</p>
<p><strong>Parameters:</strong></p>
<p><strong><em>amount</em></strong>: withdrawal amount.</p>
<p><strong><em>description</em></strong>: withdrawal description.</p>
<p><strong><em>xero</em></strong>: xero connection object.</p>
<p><strong><em>contact_id</em></strong>: Xero contact id.</p>
<p><strong><em>account_id</em></strong>: Xero account id.</p>
<p><strong>Returns:</strong></p>
<p>True is successful. False if unsuccessful.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">withdraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Withdrawal&quot;</span><span class="p">,</span> <span class="n">xero</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contact_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">account_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>Check the withdrawal amount is &gt; 0 and that the account has sufficient funds for withdrawal</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_check</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">xero</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xero</span> <span class="ow">and</span> <span class="n">contact_id</span><span class="p">:</span>
                <span class="n">transaction</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="s1">&#39;SPEND&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;Contact&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ContactID&#39;</span><span class="p">:</span> <span class="n">contact_id</span><span class="p">},</span>
                    <span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
                    <span class="s1">&#39;LineAmountTypes&#39;</span><span class="p">:</span> <span class="s1">&#39;Inclusive&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;LineItems&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;Description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span> 
                        <span class="s1">&#39;Quantity&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span><span class="p">,</span> <span class="s1">&#39;UnitAmount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span> <span class="s1">&#39;AccountCode&#39;</span><span class="p">:</span> <span class="s1">&#39;900&#39;</span><span class="p">}],</span>
                    <span class="s1">&#39;BankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_id</span><span class="p">},</span>
                    <span class="s1">&#39;Status&#39;</span><span class="p">:</span> <span class="s1">&#39;AUTHORISED&#39;</span>
                <span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>Create Xero transaction to withdraw funds</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">xero</span><span class="o">.</span><span class="n">banktransactions</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>Create bankif transaction to withdraw funds</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">t</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">account</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="n">Transaction</span><span class="o">.</span><span class="n">DEBIT</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span> 
                    <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>Save Bankifi Transaction</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p><strong>transaction_check(self, amount, xero=None)</strong></p>
<p>Checks account has sufficient funds prior to making withdrawal.</p>
<p>Will include the funds available within a sweep account as part of the check if necessary.</p>
<p><strong>Parameters:</strong></p>
<p><strong><em>amount</em></strong>: withdrawal amount</p>
<p><strong><em>xero</em></strong>: xero connection object</p>
<p><strong>Returns:</strong></p>
<p>True if successful. False if unsuccessful.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">transaction_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">xero</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_account</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sweep_account</span><span class="o">.</span><span class="n">transaction_check</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">user</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sweep</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">xero</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>@property
def balance(self):</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="c1">#     &quot;&quot;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <pre><code>**balance(self)**
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <pre><code>Returns the balance of the bank account.
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <pre><code>Aggregates the transactions against the account to find the current balance.
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      <pre><code>**Returns:**
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <pre><code>The account balance or 0 if no transactions exist.
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="c1">#     &quot;&quot;&quot;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <pre><code>if Transaction.objects.filter(account_id=self.id).exists():
    return Transaction.objects.filter(account_id=self.id).aggregate(Sum('amount')).get('amount__sum',0.0)
else:
    return 0.0
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <p><strong>balance(self, user)</strong></p>
<p>Returns the balance of the bank account.</p>
<p>Aggregates the transactions against the account to find the current balance.</p>
<p><strong>Returns:</strong></p>
<p>The account balance or 0 if no transactions exist.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">account_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">account_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;amount__sum&#39;</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;{0} {1} {2}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bank</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">account_number</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;cashflow:accountdetail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <p><strong>TransactionManager(models.Manager)</strong></p>
<p>Provides a number of aggregation methods for the Transaction Class.</p>
<p><strong>Methods:</strong></p>
<ol>
<li><strong><em>networth</em></strong> - Returns the networth of the individual.</li>
<li><strong><em>debits</em></strong> - Returns the total value of debits across accounts.</li>
<li><strong><em>credit</em></strong> - Returns the total valie of credits across accounts.</li>
</ol>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">TransactionManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>
      <p><strong>networth(self)</strong></p>
<p>Returns the total networth of the account balances.</p>
<p><strong>Returns:</strong></p>
<p>The networth.</p>
<p>TODO: At the moment we just total the amount and do no currency conversion. This needs to be done.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">networth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">months</span><span class="p">,</span> <span class="n">totals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans_stats</span><span class="p">({</span><span class="s1">&#39;customer&#39;</span><span class="p">:</span> <span class="n">customer</span><span class="p">,</span> <span class="s1">&#39;amount__isnull&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">},</span> <span class="n">base</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;months&#39;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span> <span class="s1">&#39;networths&#39;</span><span class="p">:</span> <span class="n">totals</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>
      <p>return {}</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      <p><strong>debit_total(self)</strong></p>
<p>Returns the total value of all debits across accounts.</p>
<p><strong>Returns:</strong></p>
<p>The total networth across accounts.</p>
<p>TODO: At the moment we just total the amount and do no currency conversion. This needs to be done.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">networth_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-93'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-93'>#</a>
      </div>
      <p>Using the database to do all the work using aggregation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">total</span> <span class="o">=</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span> <span class="n">amount__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span>\
                                <span class="n">aggregate</span><span class="p">(</span><span class="n">networth</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;networth&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-94'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-94'>#</a>
      </div>
      <p><strong>credits(self)</strong></p>
<p>Returns the total value of all credits across accounts.</p>
<p><strong>Returns:</strong></p>
<p>The total credits.</p>
<p>TODO: At the moment we just total the amount and do no currency conversion. This needs to be done.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">credits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-95'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-95'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">months</span><span class="p">,</span> <span class="n">totals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans_stats</span><span class="p">({</span><span class="s1">&#39;customer&#39;</span><span class="p">:</span> <span class="n">customer</span><span class="p">,</span> <span class="s1">&#39;amount__isnull&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> 
                        <span class="s1">&#39;transaction_type&#39;</span><span class="p">:</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">CREDIT</span><span class="p">},</span> <span class="n">base</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;months&#39;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span> <span class="s1">&#39;credits&#39;</span><span class="p">:</span> <span class="n">totals</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-96'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-96'>#</a>
      </div>
      <p><strong>credit_total(self)</strong></p>
<p>Returns the total value of all credits across accounts.</p>
<p><strong>Returns:</strong></p>
<p>The total credits.</p>
<p>TODO: At the moment we just total the amount and do no currency conversion. This needs to be done.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">credit_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-97'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-97'>#</a>
      </div>
      <p>Using the database to do all the work using aggregation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">total</span> <span class="o">=</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span> <span class="n">amount__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="n">Transaction</span><span class="o">.</span><span class="n">CREDIT</span><span class="p">)</span><span class="o">.</span>\
                                <span class="n">aggregate</span><span class="p">(</span><span class="n">credits</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;credits&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-98'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-98'>#</a>
      </div>
      <p><strong>debits(self)</strong></p>
<p>Returns the total value of all debits across accounts.</p>
<p><strong>Returns:</strong></p>
<p>The total debits.</p>
<p>TODO: At the moment we just total the amount and do no currency conversion. This needs to be done.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">debits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-99'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-99'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">months</span><span class="p">,</span> <span class="n">totals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trans_stats</span><span class="p">({</span><span class="s1">&#39;customer&#39;</span><span class="p">:</span> <span class="n">customer</span><span class="p">,</span> <span class="s1">&#39;amount__isnull&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> 
                        <span class="s1">&#39;transaction_type&#39;</span><span class="p">:</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">DEBIT</span><span class="p">},</span> <span class="n">base</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;months&#39;</span><span class="p">:</span> <span class="n">months</span><span class="p">,</span> <span class="s1">&#39;debits&#39;</span><span class="p">:</span> <span class="n">totals</span><span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-100'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-100'>#</a>
      </div>
      <p><strong>debit_total(self)</strong></p>
<p>Returns the total value of all debits across accounts.</p>
<p><strong>Returns:</strong></p>
<p>The total debits.</p>
<p>TODO: At the moment we just total the amount and do no currency conversion. This needs to be done.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">debit_total</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">customer</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-101'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-101'>#</a>
      </div>
      <p>Using the database to do all the work using aggregation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">total</span> <span class="o">=</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">customer</span><span class="o">=</span><span class="n">customer</span><span class="p">,</span> <span class="n">amount__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">transaction_type</span><span class="o">=</span><span class="n">Transaction</span><span class="o">.</span><span class="n">DEBIT</span><span class="p">)</span><span class="o">.</span>\
                                <span class="n">aggregate</span><span class="p">(</span><span class="n">debits</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debits&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">total</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-102'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-102'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">trans_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="n">get_rates</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>

        <span class="n">transactions</span> <span class="o">=</span> <span class="n">Transaction</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">rules</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">annotate</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="n">ExtractMonth</span><span class="p">(</span><span class="s1">&#39;transdate&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">)</span><span class="o">.</span>\
                <span class="n">annotate</span><span class="p">(</span><span class="n">gbp</span><span class="o">=</span><span class="n">Case</span><span class="p">(</span>
                    <span class="n">When</span><span class="p">(</span><span class="n">currency</span><span class="o">=</span><span class="n">Transaction</span><span class="o">.</span><span class="n">GBP</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">rates</span><span class="p">[</span><span class="s1">&#39;GBP&#39;</span><span class="p">])),</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_field</span><span class="o">=</span><span class="n">FloatField</span><span class="p">(),</span>
                <span class="p">))</span><span class="o">.</span>\
                <span class="n">annotate</span><span class="p">(</span><span class="n">eur</span><span class="o">=</span><span class="n">Case</span><span class="p">(</span>
                    <span class="n">When</span><span class="p">(</span><span class="n">currency</span><span class="o">=</span><span class="n">Transaction</span><span class="o">.</span><span class="n">EURO</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">rates</span><span class="p">[</span><span class="s1">&#39;EUR&#39;</span><span class="p">])),</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_field</span><span class="o">=</span><span class="n">FloatField</span><span class="p">(),</span>
                <span class="p">))</span><span class="o">.</span>\
                <span class="n">annotate</span><span class="p">(</span><span class="n">usd</span><span class="o">=</span><span class="n">Case</span><span class="p">(</span>
                    <span class="n">When</span><span class="p">(</span><span class="n">currency</span><span class="o">=</span><span class="n">Transaction</span><span class="o">.</span><span class="n">USD</span><span class="p">,</span> <span class="n">then</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">rates</span><span class="p">[</span><span class="s1">&#39;USD&#39;</span><span class="p">])),</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_field</span><span class="o">=</span><span class="n">FloatField</span><span class="p">(),</span>
                <span class="p">))</span><span class="o">.</span>\
                <span class="n">annotate</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s1">&#39;gbp&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s1">&#39;eur&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s1">&#39;usd&#39;</span><span class="p">))</span><span class="o">.</span>\
                <span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;period&#39;</span><span class="p">)</span>
                

        <span class="n">months</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">totals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">transactions</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;period&quot;</span><span class="p">]):</span>
            <span class="n">months</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">month_name</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">group</span><span class="p">])</span>
            <span class="n">totals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">months</span><span class="p">,</span> <span class="n">totals</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-103'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-103'>#</a>
      </div>
      <p><strong>Transaction(Base)</strong></p>
<p>A representation of a bank transaction.</p>
<p>A transaction can be a debit or a credit transaction.</p>
<p>Future Work: decouple Xero calls from class to allow multiple 3rd party providers.</p>
<p><strong>Public Attributes:</strong></p>
<p><strong><em>account</em></strong>: foreign key to bank account.</p>
<p><strong><em>transaction_type</em></strong>: type of transaction; DEBIT or CREDIT.</p>
<p><strong><em>amount</em></strong>: transaction amount.</p>
<p><strong><em>contact</em></strong>: foreign key to contact for transaction.</p>
<p><strong><em>transdate</em></strong>: date and time of transaction.</p>
<p><strong><em>transaction_id</em></strong>: Id of Xero equivalent transaction.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Transaction</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-104'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-104'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">DEBIT</span> <span class="o">=</span> <span class="s1">&#39;DEBIT&#39;</span>
    <span class="n">CREDIT</span> <span class="o">=</span> <span class="s1">&#39;CREDIT&#39;</span>
    <span class="n">TRANSACTION_TYPE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">DEBIT</span><span class="p">,</span> <span class="s1">&#39;Debit&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">CREDIT</span><span class="p">,</span> <span class="s1">&#39;Credit&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">EURO</span> <span class="o">=</span> <span class="s1">&#39;EURO&#39;</span>
    <span class="n">USD</span> <span class="o">=</span> <span class="s1">&#39;USD&#39;</span>
    <span class="n">GBP</span> <span class="o">=</span> <span class="s1">&#39;GBP&#39;</span>

    <span class="n">CURRENCY</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">EURO</span><span class="p">,</span> <span class="s1">&#39;EURO&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">USD</span><span class="p">,</span> <span class="s1">&#39;USD&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">GBP</span><span class="p">,</span> <span class="s1">&#39;GBP&#39;</span><span class="p">),</span>
    <span class="p">)</span>


    <span class="n">customer</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Customer&quot;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Customer&quot;</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Account&#39;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Bank Account&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Account&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">transaction_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">TRANSACTION_TYPE</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Transaction type&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Transaction Amount&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Amount&quot;</span><span class="p">)</span>
    <span class="n">currency</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">CURRENCY</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Currency&quot;</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Currency&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">GBP</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Transaction description&quot;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Description&quot;</span><span class="p">,</span> 
        <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">contact</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;contact&#39;</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Xero Contact&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">transdate</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Date and Time&quot;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Transaction date and time&quot;</span><span class="p">,</span> 
        <span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">transaction_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Xero Account ID&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">TransactionManager</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-105'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-105'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">class</span> <span class="nc">meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-created&#39;</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-106'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-106'>#</a>
      </div>
      <p>Override save method to ensure correct amounts are applied to the account.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;{0} Payment&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-107'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-107'>#</a>
      </div>
      <p>Ensure positive amounts from credits and negative amount for debits</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREDIT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction_type</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEBIT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1.0</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Transaction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-108'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-108'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-109'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-109'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;cashflow:transactiondetail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-110'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-110'>#</a>
      </div>
      <p><strong>Loan(models.Model)</strong></p>
<p>A representation of a loan.</p>
<p>A loan can be in a PAID and OUTSTANDING state. Only one loan is currently allowed in Bankifi.</p>
<p>Future Work: support multiple loans and decouple Xero calls from class to allow multiple 3rd party providers.</p>
<p><strong>Public Attributes:</strong></p>
<p><strong><em>balance</em></strong>: loan balance.</p>
<p><strong><em>account</em></strong>: linked loan bank account.</p>
<p><strong><em>status</em></strong>: current status of the loan; PAID or OUTSTANDING.</p>
<p><strong>Methods:</strong></p>
<p><strong><em>transfer_funds</em></strong>: transfers loan funds into bank account.</p>
<p><strong><em>pay_loan</em></strong>: pay an amount off of the loan.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Loan</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-111'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-111'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">PAID</span> <span class="o">=</span> <span class="s1">&#39;PAID&#39;</span>
    <span class="n">OUTSTANDING</span> <span class="o">=</span> <span class="s1">&#39;OUTSTANDING&#39;</span>
    <span class="n">LOAN_STATUS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PAID</span><span class="p">,</span> <span class="s1">&#39;Paid&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">OUTSTANDING</span><span class="p">,</span> <span class="s1">&#39;Outstanding&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">customer</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span> 
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Customer&quot;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Customer&quot;</span><span class="p">)</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Loan Balance&quot;</span><span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;account&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">LOAN_STATUS</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">OUTSTANDING</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Status&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Status of the loan&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-112'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-112'>#</a>
      </div>
      <p><strong>transfer_funds(self, amount, xero, contact_id, account_id)</strong></p>
<p>Transfer funds from loan account to Xero and Bankifi accounts.</p>
<p>Uses a loan account pre-setup on Bankifi and Xero.</p>
<p>Future Work: Make the loan accounts more flexible and not tied to hard coded values.</p>
<p><strong>Parameters:</strong></p>
<p><strong><em>amount</em></strong>: loan amount to transfer.</p>
<p><strong><em>xero</em></strong>: xero connection object.</p>
<p><strong><em>account_id</em></strong>: account to transfer funds too.</p>
<p><strong>Returns:</strong></p>
<p>Nothing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">transfer_funds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">xero</span><span class="p">,</span> <span class="n">contact_id</span><span class="p">,</span> <span class="n">account_id</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-113'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-113'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">xero</span><span class="o">.</span><span class="n">banktransfers</span><span class="o">.</span><span class="n">put</span><span class="p">({</span>
                                <span class="s1">&#39;FromBankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="n">BFS_CODE</span><span class="p">},</span> 
                                <span class="s1">&#39;ToBankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="n">account_id</span><span class="p">},</span>
                                <span class="s1">&#39;Amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                            <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="s2">&quot;Loan Deposit for loan Id: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-114'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-114'>#</a>
      </div>
      <p><strong>pay_loan(self, amount=0, xero=None, contact_id=None, account_id='')</strong></p>
<p>Pay an amount of the loan.</p>
<p>Uses a loan account pre-setup on Bankifi and Xero.</p>
<p>Future Work: Make the loan accounts more flexible and not tied to hard coded values.</p>
<p><strong>Parameters:</strong></p>
<p><strong><em>amount</em></strong>: amount to pay off the loan.</p>
<p><strong><em>xero</em></strong>: xero connection object.</p>
<p><strong><em>contact_id</em></strong>: xero contact id.</p>
<p><strong><em>account_id</em></strong>: account to transfer funds from.</p>
<p><strong>Returns:</strong></p>
<p>Nothing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pay_loan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xero</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">contact_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">account_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-115'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-115'>#</a>
      </div>
      <p>If we are using a negative amount convert to positive</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">amount</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-116'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-116'>#</a>
      </div>
      <p>Raise an error if the loan has already been settled</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAID</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Loan has already been fully paid.&quot;</span><span class="p">),</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;loanalreadypaid&quot;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-117'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-117'>#</a>
      </div>
      <p>Check funds are available to pay off the loan</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="s2">&quot;Loan Payment for loan Id: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">xero</span><span class="p">)</span>
            <span class="n">xero</span><span class="o">.</span><span class="n">banktransfers</span><span class="o">.</span><span class="n">put</span><span class="p">({</span>
                                <span class="s1">&#39;FromBankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="n">account_id</span><span class="p">},</span> 
                                <span class="s1">&#39;ToBankAccount&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;AccountID&#39;</span><span class="p">:</span> <span class="n">BFS_CODE</span><span class="p">},</span>
                                <span class="s1">&#39;Amount&#39;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
                            <span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">+=</span> <span class="n">amount</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-118'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-118'>#</a>
      </div>
      <p>If the balance is now 0 or less set the loan to PAID state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PAID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-119'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-119'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-120'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-120'>#</a>
      </div>
      <p>return "{0}".format(self.balance(user))</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="s2">&quot;{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">balance</span><span class="p">)</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
